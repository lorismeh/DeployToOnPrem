name: Deploy Only (Testing)

# Quick deployment workflow for testing deployment fixes
# Downloads artifacts from a previous successful build and deploys them

on:
  workflow_dispatch:
    inputs:
      run_id:
        description: 'Build workflow run ID to download artifacts from (leave empty for latest)'
        required: false
        type: string
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'BCOnPremTest'
        type: choice
        options:
          - BCOnPremTest

defaults:
  run:
    shell: powershell

jobs:
  Deploy:
    runs-on: [self-hosted, bc-onprem]
    environment:
      name: ${{ inputs.environment }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Download artifacts from specific run
        if: inputs.run_id != ''
        uses: actions/download-artifact@v4
        with:
          run-id: ${{ inputs.run_id }}
          github-token: ${{ secrets.GITHUB_TOKEN }}
          path: .artifacts
          pattern: 'Apps-*'
          merge-multiple: true

      - name: Download latest successful build artifacts
        if: inputs.run_id == ''
        uses: dawidd6/action-download-artifact@v3
        with:
          workflow: CICD.yaml
          workflow_conclusion: success
          path: .artifacts
          name: Apps-.*
          name_is_regexp: true
          if_no_artifact_found: fail

      - name: List downloaded artifacts
        run: |
          Write-Host "Downloaded artifacts:"
          Get-ChildItem -Path ".artifacts" -Recurse | ForEach-Object {
            Write-Host "  $($_.FullName)"
          }

      - name: Deploy to Business Central
        env:
          AUTH_CONTEXT: ${{ secrets.BCONPREMTEST_AUTHCONTEXT }}
        run: |
          $ErrorActionPreference = "Stop"
          
          Write-Host "========================================"
          Write-Host "  Deploying to ${{ inputs.environment }}"
          Write-Host "========================================"
          Write-Host ""
          
          # Find the deployment script
          $deployScript = ".github/DeployToOnPrem.ps1"
          
          if (-not (Test-Path $deployScript)) {
            throw "Deployment script not found: $deployScript"
          }
          
          # Prepare deployment parameters (matching AL-Go format)
          $parameters = @{
            type = "CD"
            apps = (Resolve-Path ".artifacts").Path
            EnvironmentType = "OnPrem"
            EnvironmentName = "${{ inputs.environment }}"
            AuthContext = $env:AUTH_CONTEXT
          }
          
          Write-Host "Deployment Parameters:"
          Write-Host "  Type: $($parameters.type)"
          Write-Host "  Apps: $($parameters.apps)"
          Write-Host "  Environment: $($parameters.EnvironmentName)"
          Write-Host ""
          
          # Execute deployment
          & $deployScript -parameters $parameters

      - name: Deployment Summary
        if: always()
        run: |
          if ($LASTEXITCODE -eq 0) {
            Write-Host ""
            Write-Host "✅ Deployment completed successfully!" -ForegroundColor Green
          } else {
            Write-Host ""
            Write-Host "❌ Deployment failed. Check logs above for details." -ForegroundColor Red
            exit 1
          }
